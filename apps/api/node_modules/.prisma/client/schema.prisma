generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TickState {
  id          Int @id @default(1)
  currentTick Int @default(0)
}

model State {
  id               String       @id
  name             String
  cultureId        String?
  treasury         Float
  stability        Float
  territories      Int
  militaryStrength Int
  relations        Json?
  objectives       Json?
  alerts           Json?
  llmEnabled       Boolean      @default(true)
  isLlmControlled  Boolean      @default(true)
  decisionsPerEra  Int          @default(3)
  remainingQuota   Int          @default(2)
  settlements      Settlement[]
  armies           Army[]
}

model Settlement {
  id           String @id
  name         String
  cellId       Int
  pop          Float
  marketTier   Int
  garrison     Int
  ownerStateId String
  tradeLinks   Json?
  state        State  @relation(fields: [ownerStateId], references: [id])
}

model Army {
  id             String @id
  stateId        String
  locationCellId Int
  strength       Int
  supply         Int
  stance         String
  composition    Json?
  orders         Json?
  state          State  @relation(fields: [stateId], references: [id])
}

model Cell {
  id           Int      @id
  q            Int?
  r            Int?
  biome        Int?
  height       Int?
  passable     Boolean?
  movementCost Int?
  stateId      String?
  provinceId   String?
  cultureId    String?
}

model TickMetric {
  id         String   @id @default(cuid())
  tick       Int
  stateId    String?
  systemType String
  metricKey  String
  value      Float
  createdAt  DateTime @default(now())
}

enum SuggestionStatus {
  pending
  processed
}

model Suggestion {
  id          String           @id @default(cuid())
  stateId     String
  tick        Int
  text        String
  status      SuggestionStatus @default(pending)
  createdAt   DateTime         @default(now())
  processedAt DateTime?
}

model NarrativeEvent {
  id        String   @id @default(cuid())
  tick      Int
  stateId   String?
  text      String
  createdAt DateTime @default(now())
}

/// Political memory factors that adjust bilateral attitudes (A -> B)
model PoliticalMemory {
  id            String   @id @default(cuid())
  sourceStateId String
  targetStateId String
  factorKey     String
  modifierValue Float
  isStatic      Boolean  @default(false)
  expiresAtTick Int?
  eventDetails  Json?
  createdAt     DateTime @default(now())

  @@unique([sourceStateId, targetStateId, factorKey])
  @@index([sourceStateId, targetStateId])
  @@index([targetStateId, sourceStateId])
  @@index([factorKey])
  @@index([expiresAtTick])
}
